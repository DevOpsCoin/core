<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>$DEVOPS — Claim Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
  <div class="max-w-xl mx-auto mt-16 p-8 bg-gray-900 rounded-2xl shadow-lg">
    <h1 class="text-3xl font-bold text-teal-400 mb-6 text-center">$DEVOPS Claim / Vesting Portal</h1>

    <button id="connectWallet" class="w-full bg-teal-500 hover:bg-teal-400 text-black font-bold py-3 rounded-lg mb-4">
      Connect Wallet
    </button>

    <div id="walletInfo" class="hidden text-center mb-6">
      <p class="text-gray-300">Connected Wallet:</p>
      <p id="walletAddress" class="font-mono text-teal-400"></p>
    </div>

    <div id="vestingInfo" class="hidden space-y-2">
      <h2 class="text-xl font-semibold text-gray-200 mb-2">Vesting Details</h2>
      <div class="grid grid-cols-2 gap-2 text-gray-300">
        <p>Total Allocated:</p><p id="totalAllocated" class="text-right text-white font-semibold">-</p>
        <p>Already Vested:</p><p id="vestedAmount" class="text-right text-white font-semibold">-</p>
        <p>Claimable Now:</p><p id="claimable" class="text-right text-white font-semibold">-</p>
        <p>Remaining:</p><p id="remaining" class="text-right text-white font-semibold">-</p>
      </div>

      <button id="claimBtn" class="w-full mt-6 bg-teal-500 hover:bg-teal-400 text-black font-bold py-3 rounded-lg disabled:opacity-50" disabled>
        Claim Tokens
      </button>
    </div>

    <div id="status" class="mt-6 text-sm text-center text-gray-400"></div>
  </div>

  <script>
    const TOKEN_DECIMALS = 18;
    const VESTING_CONTRACTS = [
      "0xTREASURY_VESTING_ADDRESS",
      "0xSHIPIT_VESTING_ADDRESS"
    ];
    const ABI = [
      "function vestings(address) view returns (uint256 totalAmount, uint256 released, uint64 start, uint64 duration)",
      "function vestedAmount(address, uint64) view returns (uint256)",
      "function release()"
    ];

    let provider, signer, userAddress;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask is required to use this site.");
        return;
      }

      provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      userAddress = await signer.getAddress();

      document.getElementById("walletInfo").classList.remove("hidden");
      document.getElementById("walletAddress").innerText = userAddress;
      document.getElementById("status").innerText = "Connected to wallet.";

      await loadVestingData();
    }

    async function loadVestingData() {
      let totalAllocated = ethers.toBigInt(0);
      let totalReleased = ethers.toBigInt(0);
      let vested = ethers.toBigInt(0);

      const now = Math.floor(Date.now() / 1000);

      for (const address of VESTING_CONTRACTS) {
        const contract = new ethers.Contract(address, ABI, provider);
        try {
          const v = await contract.vestings(userAddress);
          const vestedNow = await contract.vestedAmount(userAddress, now);

          totalAllocated += v.totalAmount;
          totalReleased += v.released;
          vested += vestedNow;
        } catch (err) {
          console.warn("No vesting found in contract:", address);
        }
      }

      const claimable = vested - totalReleased;
      const remaining = totalAllocated - vested;

      const fmt = (n) => Number(ethers.formatUnits(n, TOKEN_DECIMALS)).toLocaleString(undefined, { maximumFractionDigits: 2 });

      document.getElementById("vestingInfo").classList.remove("hidden");
      document.getElementById("totalAllocated").innerText = fmt(totalAllocated);
      document.getElementById("vestedAmount").innerText = fmt(vested);
      document.getElementById("claimable").innerText = fmt(claimable);
      document.getElementById("remaining").innerText = fmt(remaining);

      const claimBtn = document.getElementById("claimBtn");
      claimBtn.disabled = claimable <= 0;
      claimBtn.onclick = claimTokens;
    }

    async function claimTokens() {
      const contract = new ethers.Contract(VESTING_CONTRACTS[0], ABI, signer);
      try {
        document.getElementById("status").innerText = "Submitting claim transaction...";
        const tx = await contract.release();
        await tx.wait();
        document.getElementById("status").innerText = "✅ Tokens successfully claimed!";
        await loadVestingData();
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "❌ Claim failed or rejected.";
      }
    }

    document.getElementById("connectWallet").addEventListener("click", connectWallet);
  </script>
</body>
</html>
